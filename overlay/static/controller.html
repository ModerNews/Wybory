<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Kontroler WYBORY</title>

    <script
      src="https://code.jquery.com/jquery-3.4.1.min.js"
      integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
      crossorigin="anonymous"></script>

    <style>
      button {
        font-size: 1.2em;
      }
    </style>
  </head>
  <body style="font-family: Segoe UI, Roboto">
    <h1>Panel sterowania nakładką CG</h1>
    <input type="checkbox" id="emblem-visible"/>
    <label for="emblem-visible">Pokaż logo</label>
    <hr>
    <h2>Belka informacyjna</h2>
    <p>Po jednej wiadomości na linię</p>
    <textarea id="infobar-content" style="width: 500px; height: 120px; background: #eee"></textarea>
    <br>
    <br>
    <button id="infobar-update">Aktualizuj treść</button>
    <hr>
	<h2>Pasek z tekstem</h2>
	<select id="textbar-content" size="10" style="width:400px"></select>
	<br>
	<br>
	<input id="textbar-clock" type="checkbox">
	<label for="textbar-clock">Pokaż zegar</label>
	<br>
	<input id="textbar-bold" type="checkbox">
	<label for="textbar-bold">Pogrubiony tekst</label>
	<br><br>
	<input id="textbar-text" type="text" style="width: 400px">
	<br><br>
	<button id="textbar-show">Pokaż</button>
	<button id="textbar-hide">Ukryj</button>
  <button id="textbar-update">Podmień tekst</button>
  <hr>
  <h2>Stoper</h2>
  <b id="timer-current" style="font-size: 1.3em">00:00</b>
  <button id="timer-start">Wznów</button>
  <button id="timer-stop">Zatrzymaj</button>
  <br><br>
  <input id="timer-value" type="text" value="02:00">
  <button id="timer-set">Ustaw i zatrzymaj</button>
  <hr>
  <h2>Wyniki wyborów</h2>
  <p>Said Hannoush <input type="number" id="vote-count1"> <button class="vote-show" data-which="1">Pokaż</button></p>
  <p>Igor Hołowacz <input type="number" id="vote-count2"> <button class="vote-show" data-which="2">Pokaż</button></p>
  <p>Krzysztof Puterko <input type="number" id="vote-count3"> <button class="vote-show" data-which="3">Pokaż</button></p>
  <p>Emilia Rynkiewicz <input type="number" id="vote-count4"> <button class="vote-show" data-which="4">Pokaż</button></p>
  <p>Maksymilian Skica <input type="number" id="vote-count5"> <button class="vote-show" data-which="5">Pokaż</button></p>
  <p>Michał Strugarek <input type="number" id="vote-count6"> <button class="vote-show" data-which="6">Pokaż</button></p>

    <script>
      let ws;
      let predefs = [];
      let timerState = {
        running: false,
        time: 0,
        startedAt: 0,
      };

      function createWebsocket() {
        ws = new WebSocket("ws://" + location.hostname + ":" + location.port + "/websocket");
        ws.onopen = function(evt) { onOpen(evt) };
        ws.onclose = function(evt) { onClose(evt) };
        ws.onmessage = function(evt) { onMessage(evt) };
        ws.onerror = function(evt) { onError(evt) };

        function onOpen(evt)
        {

        }

        function onClose(evt)
        {
          console.log("Trying to reconnect...");
          setTimeout(createWebsocket, 1000);
        }

        function onMessage(evt)
        {
          let data = JSON.parse(evt.data);
          if(data.event === 'infobar') {
            $('#infobar-content').val(data.content.join('\r\n'));
          }
          if(data.event === 'show_emblem') {
            $('#emblem-visible').prop('checked', data.value);
          }
          if(data.event === 'predefs') {
            $('#textbar-content').empty();
            predefs = data.content;
            data.content.forEach((element, i) => {
              let opt = $('<option></option>');
              opt.text(element);
              opt.attr('value', i);
              $('#textbar-content').append(opt);
            });
          }
          if(data.event === 'timer_state') {
            timerState = data.state;

            if(timerState.running) {
              timerState.startedAt = Date.now();
            }
          }
        }

        function onError(evt)
        {
            console.error("socket error");
        }
      }

      createWebsocket();

      $('#infobar-update').click(() => {
        let currVal = $('#infobar-content').val();
        let arr = currVal.split('\n');
        let out = [];

        arr.forEach(elm => {
          let temp = elm.trim();
          if(temp) {
            out.push(temp);
          }
        });

        ws.send(JSON.stringify({
          event: 'infobar',
          content: out,
        }));
      });

      $('#emblem-visible').change(() => {
        ws.send(JSON.stringify({
          event: 'show_emblem',
          value: $('#emblem-visible').is(':checked'),
        }));
      });

      $('#textbar-content').change(() => {
      let val = $('#textbar-content').val();
      $('#textbar-text').val(predefs[parseInt(val)]);
      });

      $('#textbar-show').click(() => {
        ws.send(JSON.stringify({
          event: 'show_textbar',
          type: $('#textbar-clock').is(':checked')?2:1,
          bold: $('#textbar-bold').is(':checked'),
          text: $('#textbar-text').val(),
        }));
      });

      $('#textbar-update').click(() => {
        ws.send(JSON.stringify({
          event: 'update_textbar',
          bold: $('#textbar-bold').is(':checked'),
          text: $('#textbar-text').val(),
        }));
      });

      $('#textbar-hide').click(() => {
        ws.send(JSON.stringify({
          event: 'hide_textbar'
        }));
      });

      $('#timer-start').click(() => {
        ws.send(JSON.stringify({
          event: 'timer',
          type: 'start'
        }));
      });

      $('#timer-stop').click(() => {
        ws.send(JSON.stringify({
          event: 'timer',
          type: 'stop'
        }));
      });

      $('#timer-set').click(() => {
        let timerValue = $('#timer-value').val();
        let tim = timerValue.split(':');

        let seconds = parseInt(tim[0]) * 60 + parseInt(tim[1]);

        ws.send(JSON.stringify({
          event: 'timer',
          type: 'set',
          time: seconds
        }));
      });

      function voteSum() {
        let sum = 0;
        for(let i = 1; i <= 6; i++) {
          let v = $('#vote-count' + i).val();
          sum += parseInt(v);
        }

        return sum;
      }

      $('.vote-show').click((e) => {
        let which = parseInt($(e.target).attr('data-which'));

        ws.send(JSON.stringify({
          event: 'reveal_result',
          which,
          value: parseInt($('#vote-count' + which).val()),
          total: voteSum(),
        }));
      });

      setInterval(() => { // Update timer
        let time = timerState.time;

        if(timerState.running) {
          let current = Date.now();
          let realTime = (current - timerState.startedAt) / 1000;

          time = Math.max(
            timerState.time - realTime, 0);
        }

        // Set up info
        let time2 = Math.floor(time);
        let minutes = Math.floor(time2 / 60);
        let seconds = Math.floor(time2 % 60);

        let timeStrng = (((minutes<10)?('0'):('')) + minutes
          + ':' + ((seconds<10)?('0'):('')) + seconds);

        $('#timer-current').text(timeStrng);
      }, 250);
    </script>
  </body>
</html>
